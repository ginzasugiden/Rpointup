<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥½å¤© å•†å“åˆ¥ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #bf0000 0%, #8b0000 100%);
            color: white;
            padding: 24px 32px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        .header p {
            margin: 8px 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 32px;
        }
        .form-section {
            margin-bottom: 32px;
        }
        .form-section h2 {
            font-size: 16px;
            color: #333;
            margin: 0 0 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #bf0000;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group label .required {
            color: #bf0000;
            margin-left: 4px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="datetime-local"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #bf0000;
            box-shadow: 0 0 0 3px rgba(191, 0, 0, 0.1);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group .hint {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .point-rate-display {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        .point-rate-display input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        .point-rate-display input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #bf0000;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .point-rate-value {
            font-size: 24px;
            font-weight: bold;
            color: #bf0000;
            min-width: 60px;
            text-align: center;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #bf0000;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #bf0000 0%, #8b0000 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(191, 0, 0, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        .btn-secondary:hover {
            background: #e8e8e8;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 32px;
        }
        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .status-message.loading {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        .shop-select-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 2px solid #ffcc02;
        }
        .shop-select-section select {
            font-size: 16px;
            font-weight: 600;
        }
        .shop-info {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
        .shop-info .shop-name {
            font-weight: bold;
            color: #333;
            font-size: 15px;
        }
        .preview-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 24px;
        }
        .preview-section h3 {
            margin: 0 0 12px;
            font-size: 14px;
            color: #666;
        }
        .preview-section pre {
            background: #263238;
            color: #aed581;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            margin: 0;
        }
        .items-list {
            margin-top: 12px;
        }
        .item-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            margin: 4px 4px 4px 0;
        }
        .loading-shops {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .loading-shops::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-top-color: #bf0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* æ—¥æ™‚é¸æŠ */
        .datetime-select {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .date-input {
            flex: 1;
            min-width: 140px;
        }
        .hour-select {
            width: 80px;
            text-align: center;
        }
        .time-suffix {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }
        .validation-error {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }
        .auth-status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }
        .auth-status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .auth-status.error {
            background: #ffebee;
            color: #c62828;
        }
        .auth-status.loading {
            background: #e3f2fd;
            color: #1565c0;
        }
        /* å•†å“æ¤œç´¢ */
        .search-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-header {
            margin-bottom: 12px;
        }
        .search-header label {
            font-weight: 600;
            color: #333;
        }
        .search-controls {
            display: flex;
            gap: 8px;
        }
        .search-controls input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-controls input:focus {
            outline: none;
            border-color: #bf0000;
        }
        .search-controls input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        .btn-search {
            background: #1976d2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        .btn-search:hover:not(:disabled) {
            background: #1565c0;
        }
        .btn-search:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-small:hover {
            background: #e8e8e8;
        }
        .btn-danger {
            background: #ffebee;
            color: #c62828;
            border-color: #ef9a9a;
        }
        .btn-danger:hover {
            background: #ffcdd2;
        }
        .search-status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        .search-status.loading {
            background: #e3f2fd;
            color: #1565c0;
        }
        .search-status.error {
            background: #ffebee;
            color: #c62828;
        }
        .search-results {
            margin-top: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }
        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 8px 8px 0 0;
        }
        .search-results-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .search-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            gap: 12px;
        }
        .search-item:last-child {
            border-bottom: none;
        }
        .search-item:hover {
            background: #fafafa;
        }
        .search-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #bf0000;
        }
        .search-item-info {
            flex: 1;
            min-width: 0;
        }
        .search-item-title {
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-item-id {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .search-item-price {
            font-weight: 600;
            color: #bf0000;
            white-space: nowrap;
        }
        .search-pagination {
            padding: 12px 16px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        .search-pagination button {
            margin: 0 4px;
        }
        /* é¸æŠæ¸ˆã¿å•†å“ */
        .selected-items-section {
            background: #fff8e1;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #ffcc02;
        }
        .selected-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .selected-items-header label {
            font-weight: 600;
            color: #333;
        }
        .selected-items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .selected-items-list .no-items {
            color: #999;
            font-size: 14px;
            margin: 0;
        }
        .selected-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 13px;
            border: 1px solid #e0e0e0;
        }
        .selected-item .remove-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }
        .selected-item .remove-btn:hover {
            color: #c62828;
        }
        /* æ‰‹å‹•å…¥åŠ› */
        .manual-input-section {
            margin-top: 16px;
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 8px;
        }
        .manual-input-section summary {
            cursor: pointer;
            font-weight: 500;
            color: #666;
        }
        .manual-input-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
        }
        /* çµæœè©³ç´° */
        .results-detail {
            margin-top: 16px;
            font-size: 13px;
        }
        .results-detail .result-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
        }
        .results-detail .result-item.success {
            background: #e8f5e9;
        }
        .results-detail .result-item.error {
            background: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª æ¥½å¤© å•†å“åˆ¥ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š</h1>
            <p>å•†å“ç®¡ç†ç•ªå·ã‚’æŒ‡å®šã—ã¦ãƒã‚¤ãƒ³ãƒˆå¤‰å€ã‚’ä¸€æ‹¬è¨­å®š</p>
        </div>
        
        <div class="content">
            <!-- åº—èˆ—èªè¨¼ -->
            <div class="shop-select-section">
                <div class="form-group">
                    <label>ğŸ” åº—èˆ—èªè¨¼</label>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åº—èˆ—ID<span class="required">*</span></label>
                        <input type="text" id="shopId" placeholder="åº—èˆ—IDã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group">
                        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰<span class="required">*</span></label>
                        <input type="password" id="shopPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                </div>
                <div id="authStatus" class="auth-status" style="display: none;"></div>
            </div>

            <!-- å•†å“è¨­å®š -->
            <div class="form-section">
                <h2>ğŸ“¦ å¯¾è±¡å•†å“</h2>
                
                <!-- å•†å“æ¤œç´¢ -->
                <div class="search-box">
                    <div class="search-header">
                        <label>ğŸ” å•†å“æ¤œç´¢</label>
                        <p class="hint">èªè¨¼å¾Œã«æ¤œç´¢ã§ãã¾ã™ã€‚æ¤œç´¢çµæœã‹ã‚‰å•†å“ã‚’é¸æŠã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <div class="search-controls">
                        <input type="text" id="searchKeyword" placeholder="å•†å“åã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" disabled>
                        <button type="button" class="btn btn-search" id="searchBtn" onclick="searchItems()" disabled>
                            æ¤œç´¢
                        </button>
                    </div>
                    <div id="searchStatus" class="search-status" style="display: none;"></div>
                    
                    <!-- æ¤œç´¢çµæœ -->
                    <div id="searchResults" class="search-results" style="display: none;">
                        <div class="search-results-header">
                            <span id="searchResultCount">0ä»¶ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</span>
                            <button type="button" class="btn btn-small" onclick="addSelectedItems()">
                                âœ… é¸æŠã—ãŸå•†å“ã‚’è¿½åŠ 
                            </button>
                        </div>
                        <div id="searchResultsList" class="search-results-list"></div>
                        <div id="searchPagination" class="search-pagination"></div>
                    </div>
                </div>
                
                <!-- é¸æŠæ¸ˆã¿å•†å“ -->
                <div class="selected-items-section">
                    <div class="selected-items-header">
                        <label>ğŸ“‹ é¸æŠæ¸ˆã¿å•†å“ (<span id="selectedCount">0</span>ä»¶)</label>
                        <button type="button" class="btn btn-small btn-danger" onclick="clearSelectedItems()">
                            ğŸ—‘ï¸ å…¨ã¦ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <div id="selectedItemsList" class="selected-items-list">
                        <p class="no-items">å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
                
                <!-- æ‰‹å‹•å…¥åŠ›ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
                <details class="manual-input-section">
                    <summary>ğŸ“ å•†å“ç®¡ç†ç•ªå·ã‚’ç›´æ¥å…¥åŠ›</summary>
                    <div class="form-group" style="margin-top: 12px;">
                        <textarea id="manageNumbers" placeholder="å•†å“ç®¡ç†ç•ªå·ã‚’1è¡Œã«1ã¤ãšã¤å…¥åŠ›&#10;ä¾‹:&#10;item-001&#10;item-002"></textarea>
                        <button type="button" class="btn btn-small" onclick="addManualItems()" style="margin-top: 8px;">
                            â• å…¥åŠ›ã—ãŸå•†å“ã‚’è¿½åŠ 
                        </button>
                    </div>
                </details>
            </div>

            <!-- ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š -->
            <div class="form-section">
                <h2>ğŸ¯ ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š</h2>
                
                <div class="form-group">
                    <label>ãƒã‚¤ãƒ³ãƒˆå¤‰å€ç‡<span class="required">*</span></label>
                    <div class="point-rate-display">
                        <input type="range" id="pointRateSlider" min="1" max="20" value="2">
                        <div class="point-rate-value"><span id="pointRateValue">2</span>å€</div>
                    </div>
                    <p class="hint">1ã€œ20å€ã®ç¯„å›²ã§è¨­å®šï¼ˆåº—èˆ—è² æ‹…ãƒã‚¤ãƒ³ãƒˆï¼‰</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æ™‚<span class="required">*</span></label>
                        <div class="datetime-select">
                            <input type="date" id="startDate" class="date-input">
                            <select id="startHour" class="hour-select">
                            </select>
                            <span class="time-suffix">:00:00</span>
                        </div>
                        <p class="hint">ç¾åœ¨æ™‚åˆ»ã®2æ™‚é–“å¾Œã€œ60æ—¥å¾Œã¾ã§</p>
                    </div>
                    <div class="form-group">
                        <label>çµ‚äº†æ—¥æ™‚</label>
                        <div class="datetime-select">
                            <input type="date" id="endDate" class="date-input">
                            <select id="endHour" class="hour-select">
                            </select>
                            <span class="time-suffix">:59:59</span>
                        </div>
                        <p class="hint">é–‹å§‹æ—¥æ™‚ã‚ˆã‚Šå¾Œã®æ™‚é–“ã‚’é¸æŠ</p>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="noEndDate">
                        <label for="noEndDate" style="margin: 0; font-weight: normal;">çµ‚äº†æ—¥æ™‚ã‚’è¨­å®šã—ãªã„ï¼ˆç„¡æœŸé™ï¼‰</label>
                    </div>
                </div>
                
                <div id="dateValidationError" class="validation-error" style="display: none;">
                    âš ï¸ çµ‚äº†æ—¥æ™‚ã¯é–‹å§‹æ—¥æ™‚ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="preview-section">
                <h3>ğŸ“‹ é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <pre id="previewJson">{}</pre>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="statusMessage" class="status-message"></div>
            <div id="resultsDetail" class="results-detail"></div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">ãƒªã‚»ãƒƒãƒˆ</button>
                <button type="button" class="btn btn-primary" id="submitBtn" onclick="submitData()">
                    <span>ğŸš€</span> ãƒã‚¤ãƒ³ãƒˆå¤‰å€ã‚’è¨­å®š
                </button>
            </div>
        </div>
    </div>

    <!-- éš ã—iframeï¼ˆPOSTç”¨ï¼‰ -->
    <iframe id="submitFrame" name="submitFrame" style="display:none;"></iframe>

    <script>
        // ===========================================
        // è¨­å®š - ã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
        // ===========================================
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDk1TxHZL7lUtYmccXj5q5-YW_CI7W_x2QQp88NB6JDiD8cKC3-KJRUy2y3g_InBTdEw/exec';
        // ===========================================

        let shops = [];
        let authenticatedShop = null; // èªè¨¼æ¸ˆã¿åº—èˆ—æƒ…å ±
        let selectedItems = new Map(); // é¸æŠæ¸ˆã¿å•†å“ (manageNumber -> itemæƒ…å ±)
        let searchCursorMark = null; // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ™‚é–“ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
            initHourSelects();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é–‹å§‹æ—¥æ™‚ï¼ˆ3æ™‚é–“å¾Œï¼‰
            setDefaultDateTime();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
            
            updatePreview();
        });

        // æ™‚é–“ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆ0ã€œ23æ™‚ï¼‰
        function initHourSelects() {
            const startHourSelect = document.getElementById('startHour');
            const endHourSelect = document.getElementById('endHour');
            
            for (let h = 0; h < 24; h++) {
                const hourStr = String(h).padStart(2, '0');
                
                const option1 = document.createElement('option');
                option1.value = h;
                option1.textContent = hourStr + 'æ™‚';
                startHourSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = h;
                option2.textContent = hourStr + 'æ™‚';
                endHourSelect.appendChild(option2);
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥æ™‚ã‚’è¨­å®šï¼ˆ3æ™‚é–“å¾Œï¼‰
        function setDefaultDateTime() {
            const now = new Date();
            now.setHours(now.getHours() + 3);
            
            document.getElementById('startDate').value = formatDateInput(now);
            document.getElementById('startHour').value = now.getHours();
            
            // çµ‚äº†æ—¥æ™‚ã¯é–‹å§‹ã®1æ™‚é–“å¾Œ
            const endTime = new Date(now);
            endTime.setHours(endTime.getHours() + 1);
            document.getElementById('endDate').value = formatDateInput(endTime);
            document.getElementById('endHour').value = endTime.getHours();
        }

        // æ—¥ä»˜ã‚’input[type=date]å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // é–‹å§‹æ—¥æ™‚å¤‰æ›´æ™‚ã«çµ‚äº†æ—¥æ™‚ã‚’æ¤œè¨¼ãƒ»èª¿æ•´
            document.getElementById('startDate').addEventListener('change', validateAndAdjustEndDateTime);
            document.getElementById('startHour').addEventListener('change', validateAndAdjustEndDateTime);
            
            // çµ‚äº†æ—¥æ™‚å¤‰æ›´æ™‚ã«æ¤œè¨¼
            document.getElementById('endDate').addEventListener('change', validateEndDateTime);
            document.getElementById('endHour').addEventListener('change', validateEndDateTime);
            
            // å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            ['startDate', 'startHour', 'endDate', 'endHour'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePreview);
                document.getElementById(id).addEventListener('input', updatePreview);
            });
            
            // åº—èˆ—ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã«æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('shopId').addEventListener('input', checkAuthInputs);
            document.getElementById('shopPassword').addEventListener('input', checkAuthInputs);
            
            // Enterã‚­ãƒ¼ã§æ¤œç´¢
            document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchItems();
                }
            });
        }
        
        // åº—èˆ—ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function checkAuthInputs() {
            const shopId = document.getElementById('shopId').value.trim();
            const shopPassword = document.getElementById('shopPassword').value;
            
            if (shopId && shopPassword) {
                enableSearch();
            } else {
                disableSearch();
            }
            updatePreview();
        }

        // é–‹å§‹æ—¥æ™‚ã‚’å–å¾—
        function getStartDateTime() {
            const date = document.getElementById('startDate').value;
            const hour = parseInt(document.getElementById('startHour').value);
            if (!date) return null;
            return new Date(date + 'T' + String(hour).padStart(2, '0') + ':00:00');
        }

        // çµ‚äº†æ—¥æ™‚ã‚’å–å¾—
        function getEndDateTime() {
            const date = document.getElementById('endDate').value;
            const hour = parseInt(document.getElementById('endHour').value);
            if (!date) return null;
            return new Date(date + 'T' + String(hour).padStart(2, '0') + ':59:59');
        }

        // çµ‚äº†æ—¥æ™‚ã‚’æ¤œè¨¼ãƒ»èª¿æ•´ï¼ˆé–‹å§‹æ—¥æ™‚å¤‰æ›´æ™‚ï¼‰
        function validateAndAdjustEndDateTime() {
            const startDT = getStartDateTime();
            const endDT = getEndDateTime();
            
            if (startDT && endDT && endDT <= startDT) {
                // çµ‚äº†æ—¥æ™‚ã‚’é–‹å§‹æ—¥æ™‚ã®1æ™‚é–“å¾Œã«è‡ªå‹•èª¿æ•´
                const newEnd = new Date(startDT);
                newEnd.setHours(newEnd.getHours() + 1);
                document.getElementById('endDate').value = formatDateInput(newEnd);
                document.getElementById('endHour').value = newEnd.getHours();
            }
            
            hideValidationError();
            updatePreview();
        }

        // çµ‚äº†æ—¥æ™‚ã‚’æ¤œè¨¼
        function validateEndDateTime() {
            const startDT = getStartDateTime();
            const endDT = getEndDateTime();
            const noEndDate = document.getElementById('noEndDate').checked;
            
            if (!noEndDate && startDT && endDT && endDT <= startDT) {
                showValidationError();
                return false;
            }
            
            hideValidationError();
            updatePreview();
            return true;
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showValidationError() {
            document.getElementById('dateValidationError').style.display = 'block';
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
        function hideValidationError() {
            document.getElementById('dateValidationError').style.display = 'none';
        }

        // ISO 8601å½¢å¼ï¼ˆJSTï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ - é–‹å§‹æ™‚åˆ»ç”¨ï¼ˆxx:00:00ï¼‰
        function formatStartToISO8601JST() {
            const date = document.getElementById('startDate').value;
            const hour = String(document.getElementById('startHour').value).padStart(2, '0');
            if (!date) return null;
            return `${date}T${hour}:00:00+09:00`;
        }

        // ISO 8601å½¢å¼ï¼ˆJSTï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ - çµ‚äº†æ™‚åˆ»ç”¨ï¼ˆxx:59:59ï¼‰
        function formatEndToISO8601JST() {
            const date = document.getElementById('endDate').value;
            const hour = String(document.getElementById('endHour').value).padStart(2, '0');
            if (!date) return null;
            return `${date}T${hour}:59:59+09:00`;
        }

        // èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showAuthStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            statusEl.textContent = message;
            statusEl.className = `auth-status ${type}`;
            statusEl.style.display = 'block';
        }

        // èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹éè¡¨ç¤º
        function hideAuthStatus() {
            document.getElementById('authStatus').style.display = 'none';
        }

        // ===========================================
        // å•†å“æ¤œç´¢æ©Ÿèƒ½
        // ===========================================

        // æ¤œç´¢ã‚’æœ‰åŠ¹åŒ–ï¼ˆèªè¨¼æˆåŠŸå¾Œã«å‘¼ã³å‡ºã™ï¼‰
        function enableSearch() {
            document.getElementById('searchKeyword').disabled = false;
            document.getElementById('searchBtn').disabled = false;
        }

        // æ¤œç´¢ã‚’ç„¡åŠ¹åŒ–
        function disableSearch() {
            document.getElementById('searchKeyword').disabled = true;
            document.getElementById('searchBtn').disabled = true;
        }

        // å•†å“æ¤œç´¢
        async function searchItems(cursorMark = null) {
            const shopId = document.getElementById('shopId').value.trim();
            const shopPassword = document.getElementById('shopPassword').value;
            const keyword = document.getElementById('searchKeyword').value.trim();

            if (!shopId || !shopPassword) {
                showSearchStatus('åº—èˆ—IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showSearchStatus('æ¤œç´¢ä¸­...', 'loading');

            try {
                const requestData = {
                    action: 'searchItems',
                    shopId: shopId,
                    password: shopPassword,
                    keyword: keyword,
                    cursorMark: cursorMark
                };

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    // èªè¨¼æˆåŠŸ - æ¤œç´¢ã‚’æœ‰åŠ¹åŒ–
                    enableSearch();
                    showAuthStatus(`âœ… èªè¨¼æˆåŠŸ: ${result.shopName}`, 'success');
                    
                    displaySearchResults(result.items, result.totalCount, result.nextCursorMark);
                    hideSearchStatus();
                } else {
                    if (result.error && result.error.includes('èªè¨¼')) {
                        showAuthStatus(`âŒ ${result.error}`, 'error');
                        disableSearch();
                    }
                    showSearchStatus(`âŒ ${result.error}`, 'error');
                }
            } catch (error) {
                showSearchStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // æ¤œç´¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showSearchStatus(message, type) {
            const statusEl = document.getElementById('searchStatus');
            statusEl.textContent = message;
            statusEl.className = `search-status ${type}`;
            statusEl.style.display = 'block';
        }

        // æ¤œç´¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹éè¡¨ç¤º
        function hideSearchStatus() {
            document.getElementById('searchStatus').style.display = 'none';
        }

        // æ¤œç´¢çµæœã‚’è¡¨ç¤º
        function displaySearchResults(items, totalCount, nextCursorMark) {
            const resultsContainer = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            const countEl = document.getElementById('searchResultCount');
            const paginationEl = document.getElementById('searchPagination');

            searchCursorMark = nextCursorMark;

            if (!items || items.length === 0) {
                countEl.textContent = 'å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
                resultsList.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                paginationEl.innerHTML = '';
                resultsContainer.style.display = 'block';
                return;
            }

            countEl.textContent = `${totalCount || items.length}ä»¶ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

            resultsList.innerHTML = items.map(item => {
                const isSelected = selectedItems.has(item.manageNumber);
                const price = item.price || 'ä¾¡æ ¼æœªè¨­å®š';
                return `
                    <div class="search-item">
                        <input type="checkbox" 
                               id="item-${item.manageNumber}" 
                               value="${item.manageNumber}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleSearchItem(this, '${item.manageNumber}', '${escapeHtml(item.title)}', '${price}')">
                        <div class="search-item-info">
                            <div class="search-item-title">${escapeHtml(item.title)}</div>
                            <div class="search-item-id">${item.manageNumber}</div>
                        </div>
                        <div class="search-item-price">${price}å††</div>
                    </div>
                `;
            }).join('');

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
            if (nextCursorMark) {
                paginationEl.innerHTML = `
                    <button type="button" class="btn btn-small" onclick="searchItems('${nextCursorMark}')">
                        æ¬¡ã®30ä»¶ã‚’è¡¨ç¤º â†’
                    </button>
                `;
            } else {
                paginationEl.innerHTML = '';
            }

            resultsContainer.style.display = 'block';
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                const escape = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return escape[match];
            });
        }

        // æ¤œç´¢çµæœã®å•†å“ã‚’ãƒˆã‚°ãƒ«
        function toggleSearchItem(checkbox, manageNumber, title, price) {
            if (checkbox.checked) {
                selectedItems.set(manageNumber, { manageNumber, title, price });
            } else {
                selectedItems.delete(manageNumber);
            }
            updateSelectedItemsDisplay();
            updatePreview();
        }

        // é¸æŠã—ãŸå•†å“ã‚’è¿½åŠ ï¼ˆä¸€æ‹¬ï¼‰
        function addSelectedItems() {
            const checkboxes = document.querySelectorAll('#searchResultsList input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const manageNumber = cb.value;
                const itemEl = cb.closest('.search-item');
                const title = itemEl.querySelector('.search-item-title').textContent;
                const price = itemEl.querySelector('.search-item-price').textContent.replace('å††', '');
                selectedItems.set(manageNumber, { manageNumber, title, price });
            });
            updateSelectedItemsDisplay();
            updatePreview();
        }

        // æ‰‹å‹•å…¥åŠ›ã‹ã‚‰è¿½åŠ 
        function addManualItems() {
            const text = document.getElementById('manageNumbers').value;
            const numbers = parseManageNumbers(text);
            numbers.forEach(num => {
                if (!selectedItems.has(num)) {
                    selectedItems.set(num, { manageNumber: num, title: '(æ‰‹å‹•å…¥åŠ›)', price: '' });
                }
            });
            document.getElementById('manageNumbers').value = '';
            updateSelectedItemsDisplay();
            updatePreview();
        }

        // é¸æŠæ¸ˆã¿å•†å“ã‚’å‰Šé™¤
        function removeSelectedItem(manageNumber) {
            selectedItems.delete(manageNumber);
            updateSelectedItemsDisplay();
            updatePreview();
            
            // æ¤œç´¢çµæœã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
            const checkbox = document.getElementById(`item-${manageNumber}`);
            if (checkbox) {
                checkbox.checked = false;
            }
        }

        // å…¨ã¦ã®é¸æŠæ¸ˆã¿å•†å“ã‚’ã‚¯ãƒªã‚¢
        function clearSelectedItems() {
            selectedItems.clear();
            updateSelectedItemsDisplay();
            updatePreview();
            
            // æ¤œç´¢çµæœã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚å…¨ã¦å¤–ã™
            document.querySelectorAll('#searchResultsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // é¸æŠæ¸ˆã¿å•†å“ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateSelectedItemsDisplay() {
            const listEl = document.getElementById('selectedItemsList');
            const countEl = document.getElementById('selectedCount');
            
            countEl.textContent = selectedItems.size;
            
            if (selectedItems.size === 0) {
                listEl.innerHTML = '<p class="no-items">å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            listEl.innerHTML = Array.from(selectedItems.values()).map(item => `
                <div class="selected-item">
                    <span title="${escapeHtml(item.title)}">${item.manageNumber}</span>
                    <button type="button" class="remove-btn" onclick="removeSelectedItem('${item.manageNumber}')">Ã—</button>
                </div>
            `).join('');
        }

        // æ—¥æ™‚ã‚’datetime-localå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // ISO 8601å½¢å¼ï¼ˆJSTï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatToISO8601JST(dateTimeLocalValue) {
            if (!dateTimeLocalValue) return null;
            const date = new Date(dateTimeLocalValue);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}+09:00`;
        }

        // ç„¡æœŸé™ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        document.getElementById('noEndDate').addEventListener('change', function() {
            const endDateInput = document.getElementById('endDate');
            const endHourSelect = document.getElementById('endHour');
            
            endDateInput.disabled = this.checked;
            endHourSelect.disabled = this.checked;
            
            if (this.checked) {
                hideValidationError();
            }
            updatePreview();
        });

        // å•†å“ç®¡ç†ç•ªå·ã®å…¥åŠ›å¤‰æ›´
        document.getElementById('manageNumbers').addEventListener('input', updatePreview);

        // ãƒã‚¤ãƒ³ãƒˆå¤‰å€ç‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        document.getElementById('pointRateSlider').addEventListener('input', function() {
            document.getElementById('pointRateValue').textContent = this.value;
            updatePreview();
        });

        // å•†å“ç®¡ç†ç•ªå·ã‚’ãƒ‘ãƒ¼ã‚¹
        function parseManageNumbers(text) {
            if (!text.trim()) return [];
            return text
                .split(/[\n,\s]+/)
                .map(s => s.trim())
                .filter(s => s.length > 0);
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updatePreview() {
            const shopId = document.getElementById('shopId').value;
            const manageNumbers = Array.from(selectedItems.keys()); // é¸æŠæ¸ˆã¿å•†å“ã‹ã‚‰å–å¾—
            const pointRate = parseInt(document.getElementById('pointRateSlider').value);
            const noEndDate = document.getElementById('noEndDate').checked;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼JSON
            const previewData = {
                shopId: shopId || '(æœªå…¥åŠ›)',
                manageNumbers: manageNumbers,
                pointCampaign: {
                    applicablePeriod: {
                        start: formatStartToISO8601JST(),
                        end: noEndDate ? "9999-12-31T23:59:59+09:00" : formatEndToISO8601JST()
                    },
                    benefits: {
                        pointRate: pointRate
                    }
                }
            };

            document.getElementById('previewJson').textContent = JSON.stringify(previewData, null, 2);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.innerHTML = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('shopId').value = '';
            document.getElementById('shopPassword').value = '';
            document.getElementById('manageNumbers').value = '';
            document.getElementById('searchKeyword').value = '';
            document.getElementById('pointRateSlider').value = 2;
            document.getElementById('pointRateValue').textContent = '2';
            document.getElementById('noEndDate').checked = false;
            document.getElementById('endDate').disabled = false;
            document.getElementById('endHour').disabled = false;
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('resultsDetail').innerHTML = '';
            document.getElementById('searchResults').style.display = 'none';
            hideValidationError();
            hideAuthStatus();
            hideSearchStatus();
            authenticatedShop = null;
            
            // é¸æŠæ¸ˆã¿å•†å“ã‚’ã‚¯ãƒªã‚¢
            selectedItems.clear();
            updateSelectedItemsDisplay();
            
            // æ¤œç´¢ã‚’ç„¡åŠ¹åŒ–
            disableSearch();
            
            setDefaultDateTime();
            
            updatePreview();
        }

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆèªè¨¼ä»˜ãï¼‰
        async function submitData() {
            const shopId = document.getElementById('shopId').value.trim();
            const shopPassword = document.getElementById('shopPassword').value;
            const manageNumbers = Array.from(selectedItems.keys()); // é¸æŠæ¸ˆã¿å•†å“ã‹ã‚‰å–å¾—
            const pointRate = parseInt(document.getElementById('pointRateSlider').value);
            const noEndDate = document.getElementById('noEndDate').checked;
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!shopId) {
                showStatus('åº—èˆ—IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!shopPassword) {
                showStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (manageNumbers.length === 0) {
                showStatus('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!startDate) {
                showStatus('é–‹å§‹æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!noEndDate && !endDate) {
                showStatus('çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ã€Œçµ‚äº†æ—¥æ™‚ã‚’è¨­å®šã—ãªã„ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„', 'error');
                return;
            }
            if (!noEndDate && !validateEndDateTime()) {
                showStatus('çµ‚äº†æ—¥æ™‚ã¯é–‹å§‹æ—¥æ™‚ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚ã‚‹ï¼‰
            const requestData = {
                action: 'updatePointCampaignWithAuth',
                shopId: shopId,
                password: shopPassword,
                manageNumbers: manageNumbers,
                pointCampaign: {
                    applicablePeriod: {
                        start: formatStartToISO8601JST(),
                        end: noEndDate ? "9999-12-31T23:59:59+09:00" : formatEndToISO8601JST()
                    },
                    benefits: {
                        pointRate: pointRate
                    }
                }
            };

            // é€ä¿¡
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            showStatus('é€ä¿¡ä¸­...', 'loading');
            document.getElementById('resultsDetail').innerHTML = '';

            try {
                // Fetch APIã§no-corsã§ã¯ãªãã€é€šå¸¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                // GASã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain', // text/plainãªã‚‰ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãŒç™ºç”Ÿã—ãªã„
                    },
                    body: JSON.stringify(requestData),
                    redirect: 'follow'
                });

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å ´åˆã§ã‚‚ã€æœ€çµ‚çš„ãªJSONã‚’å–å¾—
                const result = await response.json();
                
                if (result.success) {
                    const successCount = result.results.filter(r => r.success).length;
                    const failCount = result.results.filter(r => !r.success).length;
                    
                    let message = `âœ… å‡¦ç†å®Œäº†: æˆåŠŸ ${successCount}ä»¶`;
                    if (failCount > 0) {
                        message += `, å¤±æ•— ${failCount}ä»¶`;
                    }
                    showStatus(message, failCount > 0 ? 'error' : 'success');
                    
                    // èªè¨¼æˆåŠŸã‚’è¡¨ç¤º
                    if (result.shopName) {
                        showAuthStatus(`âœ… èªè¨¼æˆåŠŸ: ${result.shopName}`, 'success');
                    }
                    
                    // è©³ç´°çµæœã‚’è¡¨ç¤º
                    showResultsDetail(result.results);
                } else {
                    // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                    if (result.error && result.error.includes('èªè¨¼')) {
                        showAuthStatus(`âŒ ${result.error}`, 'error');
                    }
                    showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        // çµæœè©³ç´°ã‚’è¡¨ç¤º
        function showResultsDetail(results) {
            const detailEl = document.getElementById('resultsDetail');
            detailEl.innerHTML = results.map(r => `
                <div class="result-item ${r.success ? 'success' : 'error'}">
                    ${r.success ? 'âœ…' : 'âŒ'} ${r.manageNumber}
                    ${r.error ? `: ${r.error}` : ''}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
