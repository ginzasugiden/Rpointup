<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥½å¤© å•†å“åˆ¥ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #bf0000 0%, #8b0000 100%);
            color: white;
            padding: 24px 32px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        .header p {
            margin: 8px 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 32px;
        }
        .form-section {
            margin-bottom: 32px;
        }
        .form-section h2 {
            font-size: 16px;
            color: #333;
            margin: 0 0 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #bf0000;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group label .required {
            color: #bf0000;
            margin-left: 4px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="datetime-local"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #bf0000;
            box-shadow: 0 0 0 3px rgba(191, 0, 0, 0.1);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group .hint {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .point-rate-display {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        .point-rate-display input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        .point-rate-display input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #bf0000;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .point-rate-value {
            font-size: 24px;
            font-weight: bold;
            color: #bf0000;
            min-width: 60px;
            text-align: center;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #bf0000;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #bf0000 0%, #8b0000 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(191, 0, 0, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        .btn-secondary:hover {
            background: #e8e8e8;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 32px;
        }
        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .status-message.loading {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        .shop-select-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 2px solid #ffcc02;
        }
        .shop-select-section select {
            font-size: 16px;
            font-weight: 600;
        }
        .shop-info {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
        .shop-info .shop-name {
            font-weight: bold;
            color: #333;
            font-size: 15px;
        }
        .preview-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 24px;
        }
        .preview-section h3 {
            margin: 0 0 12px;
            font-size: 14px;
            color: #666;
        }
        .preview-section pre {
            background: #263238;
            color: #aed581;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            margin: 0;
        }
        .items-list {
            margin-top: 12px;
        }
        .item-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            margin: 4px 4px 4px 0;
        }
        .loading-shops {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .loading-shops::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-top-color: #bf0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* çµæœè©³ç´° */
        .results-detail {
            margin-top: 16px;
            font-size: 13px;
        }
        .results-detail .result-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
        }
        .results-detail .result-item.success {
            background: #e8f5e9;
        }
        .results-detail .result-item.error {
            background: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª æ¥½å¤© å•†å“åˆ¥ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š</h1>
            <p>å•†å“ç®¡ç†ç•ªå·ã‚’æŒ‡å®šã—ã¦ãƒã‚¤ãƒ³ãƒˆå¤‰å€ã‚’ä¸€æ‹¬è¨­å®š</p>
        </div>
        
        <div class="content">
            <!-- åº—èˆ—é¸æŠ -->
            <div class="shop-select-section">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>ğŸ¬ å¯¾è±¡åº—èˆ—<span class="required">*</span></label>
                    <select id="shopSelect" onchange="onShopChange()">
                        <option value="">-- åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                    </select>
                    <div id="shopInfo" class="shop-info" style="display: none;">
                        <div class="shop-name" id="shopName"></div>
                        <div id="shopEmail"></div>
                    </div>
                    <div id="loadingShops" class="loading-shops">
                        åº—èˆ—æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­
                    </div>
                </div>
            </div>

            <!-- å•†å“è¨­å®š -->
            <div class="form-section">
                <h2>ğŸ“¦ å¯¾è±¡å•†å“</h2>
                <div class="form-group">
                    <label>å•†å“ç®¡ç†ç•ªå·<span class="required">*</span></label>
                    <textarea id="manageNumbers" placeholder="å•†å“ç®¡ç†ç•ªå·ã‚’1è¡Œã«1ã¤ãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹:&#10;item-001&#10;item-002&#10;item-003"></textarea>
                    <p class="hint">æ”¹è¡ŒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯èƒ½ã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚„ã‚«ãƒ³ãƒã§ã‚‚åŒºåˆ‡ã‚Œã¾ã™ã€‚</p>
                </div>
                <div id="itemsList" class="items-list"></div>
            </div>

            <!-- ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š -->
            <div class="form-section">
                <h2>ğŸ¯ ãƒã‚¤ãƒ³ãƒˆå¤‰å€è¨­å®š</h2>
                
                <div class="form-group">
                    <label>ãƒã‚¤ãƒ³ãƒˆå¤‰å€ç‡<span class="required">*</span></label>
                    <div class="point-rate-display">
                        <input type="range" id="pointRateSlider" min="1" max="20" value="2">
                        <div class="point-rate-value"><span id="pointRateValue">2</span>å€</div>
                    </div>
                    <p class="hint">1ã€œ20å€ã®ç¯„å›²ã§è¨­å®šï¼ˆåº—èˆ—è² æ‹…ãƒã‚¤ãƒ³ãƒˆï¼‰</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æ™‚<span class="required">*</span></label>
                        <input type="datetime-local" id="startDateTime">
                        <p class="hint">ç¾åœ¨æ™‚åˆ»ã®2æ™‚é–“å¾Œã€œ60æ—¥å¾Œã¾ã§</p>
                    </div>
                    <div class="form-group">
                        <label>çµ‚äº†æ—¥æ™‚</label>
                        <input type="datetime-local" id="endDateTime">
                        <p class="hint">ç©ºæ¬„ã®å ´åˆã¯ç„¡æœŸé™</p>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="noEndDate">
                        <label for="noEndDate" style="margin: 0; font-weight: normal;">çµ‚äº†æ—¥æ™‚ã‚’è¨­å®šã—ãªã„ï¼ˆç„¡æœŸé™ï¼‰</label>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="preview-section">
                <h3>ğŸ“‹ é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <pre id="previewJson">{}</pre>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="statusMessage" class="status-message"></div>
            <div id="resultsDetail" class="results-detail"></div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">ãƒªã‚»ãƒƒãƒˆ</button>
                <button type="button" class="btn btn-primary" id="submitBtn" onclick="submitData()">
                    <span>ğŸš€</span> ãƒã‚¤ãƒ³ãƒˆå¤‰å€ã‚’è¨­å®š
                </button>
            </div>
        </div>
    </div>

    <!-- éš ã—iframeï¼ˆPOSTç”¨ï¼‰ -->
    <iframe id="submitFrame" name="submitFrame" style="display:none;"></iframe>

    <script>
        // ===========================================
        // è¨­å®š - ã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
        // ===========================================
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDk1TxHZl7IUtYmccXj5a5-YW_Cl7W_x20p88NB6JDl8cKC3-KjRuGN8Ew8j0E0Y3Jcw/exec';
        // ===========================================

        let shops = [];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é–‹å§‹æ—¥æ™‚ï¼ˆ3æ™‚é–“å¾Œï¼‰
            const now = new Date();
            now.setHours(now.getHours() + 3);
            now.setMinutes(0, 0, 0);
            document.getElementById('startDateTime').value = formatDateTimeLocal(now);
            
            // åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONPæ–¹å¼ï¼‰
            loadShopsJsonp();
            
            updatePreview();
        });

        // åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONPæ–¹å¼ã§CORSå›é¿ï¼‰
        function loadShopsJsonp() {
            document.getElementById('loadingShops').style.display = 'block';
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
            window.handleShopsResponse = function(data) {
                document.getElementById('loadingShops').style.display = 'none';
                
                if (data.success && data.shops) {
                    shops = data.shops;
                    populateShopSelect();
                } else {
                    showStatus('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
                
                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
                const script = document.getElementById('jsonpScript');
                if (script) script.remove();
            };
            
            // JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const script = document.createElement('script');
            script.id = 'jsonpScript';
            script.src = `${GAS_WEB_APP_URL}?action=getShops&callback=handleShopsResponse`;
            script.onerror = function() {
                document.getElementById('loadingShops').style.display = 'none';
                showStatus('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GAS URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
            };
            document.body.appendChild(script);
        }

        // åº—èˆ—ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
        function populateShopSelect() {
            const select = document.getElementById('shopSelect');
            select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
            
            shops.forEach(shop => {
                const option = document.createElement('option');
                option.value = shop.id;
                option.textContent = shop.sname || shop.id;
                select.appendChild(option);
            });
        }

        // åº—èˆ—é¸æŠæ™‚
        function onShopChange() {
            const shopId = document.getElementById('shopSelect').value;
            const shopInfo = document.getElementById('shopInfo');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                if (shop) {
                    document.getElementById('shopName').textContent = shop.sname || shop.id;
                    document.getElementById('shopEmail').textContent = shop.email || '';
                    shopInfo.style.display = 'block';
                }
            } else {
                shopInfo.style.display = 'none';
            }
            
            updatePreview();
        }

        // æ—¥æ™‚ã‚’datetime-localå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // ISO 8601å½¢å¼ï¼ˆJSTï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatToISO8601JST(dateTimeLocalValue) {
            if (!dateTimeLocalValue) return null;
            const date = new Date(dateTimeLocalValue);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}+09:00`;
        }

        // ãƒã‚¤ãƒ³ãƒˆå¤‰å€ç‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        document.getElementById('pointRateSlider').addEventListener('input', function() {
            document.getElementById('pointRateValue').textContent = this.value;
            updatePreview();
        });

        // ç„¡æœŸé™ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        document.getElementById('noEndDate').addEventListener('change', function() {
            document.getElementById('endDateTime').disabled = this.checked;
            if (this.checked) {
                document.getElementById('endDateTime').value = '';
            }
            updatePreview();
        });

        // å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        ['manageNumbers', 'startDateTime', 'endDateTime'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        // å•†å“ç®¡ç†ç•ªå·ã‚’ãƒ‘ãƒ¼ã‚¹
        function parseManageNumbers(text) {
            if (!text.trim()) return [];
            return text
                .split(/[\n,\s]+/)
                .map(s => s.trim())
                .filter(s => s.length > 0);
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updatePreview() {
            const shopId = document.getElementById('shopSelect').value;
            const manageNumbers = parseManageNumbers(document.getElementById('manageNumbers').value);
            const pointRate = parseInt(document.getElementById('pointRateSlider').value);
            const startDateTime = document.getElementById('startDateTime').value;
            const endDateTime = document.getElementById('endDateTime').value;
            const noEndDate = document.getElementById('noEndDate').checked;

            // å•†å“ãƒªã‚¹ãƒˆè¡¨ç¤º
            const itemsList = document.getElementById('itemsList');
            if (manageNumbers.length > 0) {
                itemsList.innerHTML = manageNumbers.map(num => 
                    `<span class="item-tag">${num}</span>`
                ).join('');
            } else {
                itemsList.innerHTML = '';
            }

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼JSON
            const previewData = {
                shopId: shopId || '(æœªé¸æŠ)',
                manageNumbers: manageNumbers,
                pointCampaign: {
                    applicablePeriod: {
                        start: formatToISO8601JST(startDateTime),
                        end: noEndDate ? "9999-12-31T23:59:59+09:00" : formatToISO8601JST(endDateTime)
                    },
                    benefits: {
                        pointRate: pointRate
                    }
                }
            };

            document.getElementById('previewJson').textContent = JSON.stringify(previewData, null, 2);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.innerHTML = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('shopSelect').value = '';
            document.getElementById('shopInfo').style.display = 'none';
            document.getElementById('manageNumbers').value = '';
            document.getElementById('pointRateSlider').value = 2;
            document.getElementById('pointRateValue').textContent = '2';
            document.getElementById('noEndDate').checked = false;
            document.getElementById('endDateTime').disabled = false;
            document.getElementById('endDateTime').value = '';
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('resultsDetail').innerHTML = '';
            
            const now = new Date();
            now.setHours(now.getHours() + 3);
            now.setMinutes(0, 0, 0);
            document.getElementById('startDateTime').value = formatDateTimeLocal(now);
            
            updatePreview();
        }

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆGoogle Formã‚¹ã‚¿ã‚¤ãƒ« - iframe POSTï¼‰
        async function submitData() {
            const shopId = document.getElementById('shopSelect').value;
            const manageNumbers = parseManageNumbers(document.getElementById('manageNumbers').value);
            const pointRate = parseInt(document.getElementById('pointRateSlider').value);
            const startDateTime = document.getElementById('startDateTime').value;
            const endDateTime = document.getElementById('endDateTime').value;
            const noEndDate = document.getElementById('noEndDate').checked;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!shopId) {
                showStatus('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (manageNumbers.length === 0) {
                showStatus('å•†å“ç®¡ç†ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!startDateTime) {
                showStatus('é–‹å§‹æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!noEndDate && !endDateTime) {
                showStatus('çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ã€Œçµ‚äº†æ—¥æ™‚ã‚’è¨­å®šã—ãªã„ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„', 'error');
                return;
            }

            // é€ä¿¡ãƒ‡ãƒ¼ã‚¿
            const requestData = {
                action: 'updatePointCampaign',
                shopId: shopId,
                manageNumbers: manageNumbers,
                pointCampaign: {
                    applicablePeriod: {
                        start: formatToISO8601JST(startDateTime),
                        end: noEndDate ? "9999-12-31T23:59:59+09:00" : formatToISO8601JST(endDateTime)
                    },
                    benefits: {
                        pointRate: pointRate
                    }
                }
            };

            // é€ä¿¡
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            showStatus('é€ä¿¡ä¸­...', 'loading');
            document.getElementById('resultsDetail').innerHTML = '';

            try {
                // Fetch APIã§no-corsã§ã¯ãªãã€é€šå¸¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                // GASã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain', // text/plainãªã‚‰ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãŒç™ºç”Ÿã—ãªã„
                    },
                    body: JSON.stringify(requestData),
                    redirect: 'follow'
                });

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å ´åˆã§ã‚‚ã€æœ€çµ‚çš„ãªJSONã‚’å–å¾—
                const result = await response.json();
                
                if (result.success) {
                    const successCount = result.results.filter(r => r.success).length;
                    const failCount = result.results.filter(r => !r.success).length;
                    
                    let message = `âœ… å‡¦ç†å®Œäº†: æˆåŠŸ ${successCount}ä»¶`;
                    if (failCount > 0) {
                        message += `, å¤±æ•— ${failCount}ä»¶`;
                    }
                    showStatus(message, failCount > 0 ? 'error' : 'success');
                    
                    // è©³ç´°çµæœã‚’è¡¨ç¤º
                    showResultsDetail(result.results);
                } else {
                    showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        // çµæœè©³ç´°ã‚’è¡¨ç¤º
        function showResultsDetail(results) {
            const detailEl = document.getElementById('resultsDetail');
            detailEl.innerHTML = results.map(r => `
                <div class="result-item ${r.success ? 'success' : 'error'}">
                    ${r.success ? 'âœ…' : 'âŒ'} ${r.manageNumber}
                    ${r.error ? `: ${r.error}` : ''}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
